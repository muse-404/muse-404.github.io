---
comments: true
title: 簡單做：Telegram+Google Sheets收發報價Email
date: '2019-04-12T00:25:00.003+08:00'
author: 星尼
tags:
- tech
- stock
- googlesheet
- sgp
modified_time: '2019-04-12T09:31:22.383+08:00'
header:
 teaser: https://4.bp.blogspot.com/-3vQ1Fr8buhY/XK9iN0dWHqI/AAAAAAAAAOg/z9ujOvufRoENlEdV_7PyuR88Va85eV3vwCLcBGAs/s72-c/20190411_process.png
blogger_id: tag:blogger.com,1999:blog-7582033750535645406.post-3045557800892721955
blogger_orig_url: https://muse404.blogspot.com/2019/04/telegramgoogle-sheet-email.html
---

近日恒指終於爬上了三萬點，看到IB的帳目終於因而步出了WIN BOND受到的重創，十分感動。<br /><br />近日主要想買的有港股、新加坡（主力是REITS）和美股，網上好像也找不到一個平台可以很順暢的看這3個市場的價格。雖說IB APP也可以設定Watchlist和Alert，但就是用不慣。本來是想用之前設定的Google Sheets定時收發電郵作提示就好了，但研究一會兒發現了Telegram Bot＋Google Sheets也可以完美配合做很多個人化。由於是用Google Sheets的關係，可以用它自身的condition formatting and formula，不太費力。<br /><br />由於我不用太即市，所以報價用的只是簡單的Bloomberg取價，詳請可看<a href="https://fukluksau.blogspot.com/2017/11/BloombergXPath.html" target="_blank">全兄的文章</a><br />本來我也試過用<a href="http://investmentmoats.com/uncategorized/automatically-yahoo-finance-stock-price-google-spreadsheet/" target="_blank">Investment Moat</a>介紹的Yahoo報價，但是發覺白天還未收市時不太穩定，不想勉強，還是繼續用Bloomberg了。（但其實測試時也發覺Bloomberg取價配上importxml也不太穩定，但能用就算了吧）<br /><br /><blockquote class="tr_bq"><b>簡單來說，我的設計使用了：</b></blockquote><blockquote class="tr_bq">1. 一張已制好的Google Sheets（作為Email報告的文本內容）<br />2. Telegram Bot（我的use case是使用bot來叫程式自動Send Email）<br />3. Google Sheets裡的Script Editor</blockquote><br />我設定了如果向Telegram Bot發送消息，Google Sheet的web app就會自動用制好的報告，發送Email和回Msg到Bot裡。（由於Customize Msg比較費時，自用的我就沒做了，而Telegram能不能發送全HTML的Msg，所以不能用制好頁面直接發送，要再加工）<br /><br />如果更進一步或更即市的話，應該要加force refresh和可以從報告找輸入了的Stock code再回送特定的價格。當然報告也可以簡單的在Script Editor裡設定Trigger的指定時間，若是如此的話就不用Telegram Bot來『叫醒』它來發送電郵了。<br /><br /><span style="color: red;"><b>技術上來說，如下圖：</b></span><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-3vQ1Fr8buhY/XK9iN0dWHqI/AAAAAAAAAOg/z9ujOvufRoENlEdV_7PyuR88Va85eV3vwCLcBGAs/s1600/20190411_process.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="530" data-original-width="550" src="https://4.bp.blogspot.com/-3vQ1Fr8buhY/XK9iN0dWHqI/AAAAAAAAAOg/z9ujOvufRoENlEdV_7PyuR88Va85eV3vwCLcBGAs/s1600/20190411_process.png" /></a></div><br /><br /><span style="font-size: small;"><span style="color: red;"><b><span style="font-size: medium;">Telgram測試：</span></b></span><span style="font-size: medium;">測試時發覺大概也能兩分鐘內傳回電郵了～</span></span><br /><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-dWFvjk4Jydg/XK9kBg6rQxI/AAAAAAAAAO8/XjQxNFMXJ4MBthteI1Omo6zRbFCJbAR9QCLcBGAs/s1600/20190411_telegram.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="587" data-original-width="1080" height="173" src="https://4.bp.blogspot.com/-dWFvjk4Jydg/XK9kBg6rQxI/AAAAAAAAAO8/XjQxNFMXJ4MBthteI1Omo6zRbFCJbAR9QCLcBGAs/s320/20190411_telegram.jpeg" width="320" /></a></div><br /><span style="color: red;"><span style="font-size: small;"><b><span style="font-size: medium;">Mail收</span></b></span></span><span style="font-size: small;"><span style="color: red;"><b><span style="font-size: medium;">成品：</span></b></span><span style="font-size: medium;">可以簡單用condition formatting來標出重點</span></span><br /><br /><div class="separator" style="clear: both; text-align: left;"><span style="font-size: small;"><b><span style="font-size: medium;"><a href="https://2.bp.blogspot.com/-eQj0-EcNqx0/XK9jQggRSoI/AAAAAAAAAOo/4zHmbQH62YE5nMXjOSEzbklD3dJUVp_lgCLcBGAs/s1600/20190411_email.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="389" data-original-width="696" src="https://2.bp.blogspot.com/-eQj0-EcNqx0/XK9jQggRSoI/AAAAAAAAAOo/4zHmbQH62YE5nMXjOSEzbklD3dJUVp_lgCLcBGAs/s1600/20190411_email.PNG" /></a></span></b></span></div><br /><div class="separator" style="clear: both; text-align: center;"><span style="font-size: small;"><b><span style="font-size: medium;"><br /></span></b></span></div><br /><br /><span style="color: orange;"><b><span style="font-size: large;">制作步驟如下：</span></b></span><br /><br /><b><i>步驟0. </i></b>跟著這個Youtube感受一下如何簡單地做一個Bot，<a href="https://www.youtube.com/watch?v=mKSXd_od4Lg" target="_blank">它的舊版連程式碼也有</a>，可以直接copy跟著做。很方便。（由於是別人Youtube裡的教學，所以請去Copy吧）<br /><br /><iframe allowfullscreen="" frameborder="0" height="270" src="https://www.youtube.com/embed/24EyItKfm50" width="480"></iframe> <br /><br /><br /><i><b><b>步驟</b>1. </b></i>開張Google Sheets，設計好一個Table，作為send email的文本（如圖1)<br />*註* 由於是用google sheet的關係，可以使用大量的condition formatting來做自己想要的標記（例如正負數或上升超過某百份比）<br /><br /><i><b><b>步驟</b>2. </b></i>在Script Editor用youtube教的重覆一篇，加下個人設定，包括：<br /><ul><li>Botfather 裡開個新 Bot，抄下Token以放入GoogleSheet的Code裡</li><li>開Web App</li><li>改做成你想的設計</li></ul><div><i><b><b>步驟</b>3. </b></i>在Send Email方面，我使用了<a href="https://sites.google.com/site/scriptsexamples/custom-methods/sheetconverter" target="_blank">SheetConverter</a>，指定了特定的Range來Send Email<br /><br />a. 以下是我用來Send Email的Code<br /><code>function sendemailalert(){<br />&nbsp;&nbsp;&nbsp; var EmailRange = "A1:H10";&nbsp;&nbsp;&nbsp; //電郵主體<br />&nbsp;&nbsp;&nbsp; var TitleRange = "M1:N2"; //設定更新時間的範圍,方便電郵中參考<br />&nbsp;&nbsp;&nbsp; var spreadsheet = SpreadsheetApp.openById([YOUR GOOGLE SHEET SSID]);<br />&nbsp;&nbsp;&nbsp; var Subject = "[YOUR EMAIL TITLE]";<br />&nbsp;&nbsp;&nbsp; var s = spreadsheet.getSheetByName([YOUR GOOGLE SHEET]);<br />&nbsp;&nbsp;&nbsp; var bodyrange = s.getRange(EmailRange);<br />&nbsp;&nbsp;&nbsp; var titlerange= s.getRange(TitleRange);<br />&nbsp;&nbsp;&nbsp; var to = [YOUR EMAIL];<br />&nbsp;&nbsp;&nbsp; var body = '';<br />&nbsp;&nbsp;&nbsp; var htmlTable = SheetConverter.convertRange2html(bodyrange);<br />&nbsp;&nbsp;&nbsp; var htmlTitle = SheetConverter.convertRange2html(titlerange);<br />&nbsp;&nbsp;&nbsp; var body = htmlTable + "&lt;br/&gt;"+htmlTitle<br />&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; MailApp.sendEmail(to, Subject, body, {htmlBody: body});<br /><br />}; <br /></code></div><br /><br />b. 由於Importxml真的有時候有點廢，所以加了強制Refresh功能，可參考<br /><a href="https://stackoverflow.com/questions/33872967/periodically-refresh-importxml-spreadsheet-function">https://stackoverflow.com/questions/33872967/periodically-refresh-importxml-spreadsheet-function</a><br /><br /><b>後話：</b><br />其實這個配搭真係有無限可能性～但如果是為報價的話，後台抓不到即市價始終是輸蝕了一點。但以免費和容易在Google Sheets上做些Summary，搭配這個方便了連Google Sheets也懶開的我吧～<br /><b></b><br /><br /><span style="font-size: large;"><b>其他參考網址：</b></span><br /><a href="https://stackoverflow.com/questions/36577984/use-mailapp-to-send-formatted-data-from-spreadsheet-in-htmlbody/36834398?noredirect=1#comment61241756_36834398">https://stackoverflow.com/questions/36577984/use-mailapp-to-send-formatted-data-from-spreadsheet-in-htmlbody/36834398?noredirect=1#comment61241756_36834398</a><br /><a href="https://core.telegram.org/bots/api#message" target="_blank">https://core.telegram.org/bots/api#message </a>